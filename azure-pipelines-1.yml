trigger: none

pool: ADO_Agent

stages:
  - stage: initValidatePlan
    displayName: Init, Validate and Plan
    jobs:
      - job: initValidatePlanJob
        displayName: Init Validate Plan Job
        steps:
        - task: TerraformTask@5
          displayName: Terraform Init
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: '$(System.DefaultWorkingDirectory)/env/dev'
            backendServiceArm: 'ado_azure_sp'
            backendAzureRmStorageAccountName: 'ashokstgpipeline01'
            backendAzureRmContainerName: 'devtfstate'
            backendAzureRmKey: 'terraform.dev.tfstate'

        - task: TerraformTask@5
          displayName: Terraform Validate
          inputs:
            provider: 'azurerm'
            command: 'validate'
            workingDirectory: '$(System.DefaultWorkingDirectory)/env/dev'

        - task: TerraformTask@5
          displayName: Terraform Plan
          inputs:
            provider: 'azurerm'
            command: 'plan'
            workingDirectory: '$(System.DefaultWorkingDirectory)/env/dev'
            environmentServiceNameAzureRM: 'ado_azure_sp'

  - stage: SecurityScan
    displayName: TFSec&TFLint
    jobs:
      - job: 
        displayName: Running TFSec
        steps:
        - task: tfsec@1
          inputs:
            version: 'v1.26.0'
            dir: '$(System.DefaultWorkingDirectory)'  

      - job: Tflinit
        displayName: Tflint
        steps:
          - task: PowerShell@2
            continueOnError: true
            inputs:
             targetType: 'inline'
             script: 'tflint.exe /f junit > tflint-result.xml'
             workingDirectory: '$(System.DefaultWorkingDirectory)'
      
      - job: PublishLint
        displayName: 
        steps:
          - task: PublishTestResults@2
            inputs:
             testResultsFormat: 'JUnit'
             testResultsFiles: 'tflint-result.xml'


  - stage: ApprovalandApply
    displayName: Approval & Apply
    jobs:
      - job: approval
        pool: server
        displayName: Approval
        steps:
         - task: ManualValidation@1
           displayName: ManualValidation
           inputs:
            notifyUsers: 'ashokkumar01990@gmail.com'
            approvers: 'ashokkumar01990@gmail.com'

      - job: Apply
        displayName: Terrform  Apply
        steps:
          - task: TerraformTask@5
            displayName: Terraform Init
            inputs:
             provider: 'azurerm'
             command: 'init'
             workingDirectory: '$(System.DefaultWorkingDirectory)/env/dev'
             backendServiceArm: 'ado_azure_sp'
             backendAzureRmStorageAccountName: 'ashokstgpipeline01'
             backendAzureRmContainerName: 'devtfstate'
             backendAzureRmKey: 'terraform.dev.tfstate'

          - task: TerraformTask@5
            displayName: Terraform Apply
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: '$(System.DefaultWorkingDirectory)/env/dev'
              environmentServiceNameAzureRM: 'ado_azure_sp'       
    
    

